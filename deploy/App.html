<!DOCTYPE html>
<html>
<head>
    <title>Super Customizable Cumulative Flow Diagram</title>
    <!--  (c) 2013 Rally Software Development Corp.  All Rights Reserved. -->
    <!--  Build Date: Thu Nov 21 2013 08:37:41 GMT-0800 (PST) -->
    
    <script type="text/javascript">
        var APP_BUILD_DATE = "Thu Nov 21 2013 08:37:41 GMT-0800 (PST)";
        var CHECKSUM = 21790479192;
    </script>
    
    <script type="text/javascript" src="/apps/2.0rc1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function() {
             
/**
 * a calculator for each day of data,
 * given a snap for that day, will calculate a
 * total count for each value in a metric field (e.g., count the number of items in Defined schedule state)
 * 
 * assumes that each individual snap represents one unique item
 */
 
 Ext.define('TSDay',{
    extend: 'Ext.data.Model',
    group_totals: {},
    fields: [
        {name:'JSDate',type:'date',defaultValue:new Date()},
        {name:'groupByFieldName',type:'string',defaultValue:'ScheduleState'}, /* the name of the field that filters what we count */
        {name:'metricFieldName',type:'string',defaultValue:'Count'}, /* the name of the field with a value to add (or count), remember the c_! */
        {name:'Total',type:'number',defaultVale:0}
    ],
    constructor: function(data) {
        this.group_totals = {};
        this.callParent(arguments);
    },
    /**
     * Given a single lookback snapshot, aggregate data
     * @param {} snap
     */
    addSnap: function(snap){
        var total = this.get('Total');
        var group_by_field_name = this.get('groupByFieldName');
        var metric_field_name = this.get('metricFieldName');
        
        var value_in_snap = 0;
        if ( metric_field_name === "Count" ) {
            value_in_snap = 1;
        } else {
            if (Ext.isNumber(snap.get(metric_field_name))) {
                value_in_snap = snap.get(metric_field_name);
            }
        }
        total = total + value_in_snap;
        this.set('Total',total);
        
        var snap_value = snap.get(group_by_field_name);
        
        if ( Ext.isDefined(snap_value) ) {
            if ( Ext.isBoolean(snap_value) ) { 
                if ( snap_value ) { 
                    snap_value = "true"; 
                } else { 
                    snap_value = "false"; 
                } 
            }
            if ( ! this.group_totals[snap_value] ) { this.group_totals[snap_value] = 0; }
            this.group_totals[snap_value] = this.group_totals[snap_value] + value_in_snap;
        }
    },
    /**
     * return the aggregated value of totals for a given group (as seen in the groupByFieldName
     * (assumes if we haven't heard about the field value yet, it's just 0
     */
    getGroupTotal: function(field_value){
        return this.group_totals[field_value] || 0 ;
    }
    
 });

/**
 * A link that pops up a version dialog box
 */

Ext.define('Rally.technicalservices.InfoLink',{
    extend: 'Ext.Component',
    alias: 'widget.tsinfolink',
    
    /**
     * @cfg {String} informationHtml
     * Additional text to be displayed on the popup dialog (for exmaple,
     * to add a description of the app's use or functionality)
     */
    informationHtml: null,
    
    /**
     * 
     * cfg {String} title
     * The title for the dialog box
     */
     text: "Information",
    
    renderTpl: "<div id='{id}-infolinkWrap' class='tsinfolink'>TS</div>",

    initComponent: function() {
        this.callParent(arguments);
       
    },
    
    onRender: function() {
        this.callParent(arguments);
        this.mon(this.el,'click',this.onClick,this);
    },
    _generateChecksum: function(string){
        var chk = 0x12345678,
            i;
        string = string.replace(/var CHECKSUM = .*;/,"");
        
        for (i = 0; i < string.length; i++) {
            chk += (string.charCodeAt(i) * i);
        }
    
        return chk;
    },
    _checkChecksum: function(container) {
        var me = this;
        Ext.Ajax.request({
            url: document.URL,
            params: {
                id: 1
            },
            success: function (response) {
                text = response.responseText;
                if ( CHECKSUM ) {
                    if ( CHECKSUM !== me._generateChecksum(text) ) {
                        console.log("Checksums don't match!");
                        if ( me.dialog ) {
                            me.dialog.add({xtype:'container',html:'Checksums do not match'});
                        }
                    }
                }
            }
        });
    },
    onClick: function(e) {
        var me = this;
        this._checkChecksum(this);
        
        var dialog_items = [];
        
        if ( this.informationHtml ) {
            dialog_items.push({
                xtype:'container',
                html: this.informationHtml
            });
        }
                
        dialog_items.push({
            xtype:'container',
            html:"This app was created by the Rally Technical Services Team."
        });
        
        if ( APP_BUILD_DATE ) {
            dialog_items.push({
                xtype:'container',
                html:'Build date/time: ' + APP_BUILD_DATE
            });
        }
        
        if (this.dialog){this.dialog.destroy();}
        this.dialog = Ext.create('Rally.ui.dialog.Dialog',{
            defaults: { padding: 5, margin: 5 },
            closable: true,
            draggable: true,
            title: me.title,
            items: dialog_items
        });
        this.dialog.show();
    }
});
/*
 */
Ext.define('Rally.technicalservices.Logger',{
    constructor: function(config){
        Ext.apply(this,config);
    },
    log: function(args){
        var timestamp = "[ " + Ext.util.Format.date(new Date(), "Y-m-d H:i:s.u") + " ]";
        //var output_args = arguments;
        //output_args.unshift( [ "[ " + timestamp + " ]" ] );
        //output_args = Ext.Array.push(output_args,arguments);
        
        var output_args = [];
        output_args = Ext.Array.push(output_args,[timestamp]);
        output_args = Ext.Array.push(output_args, Ext.Array.slice(arguments,0));

        window.console && console.log.apply(console,output_args);
    }

});

Ext.define('Rally.technicalservices.SettingsDialog',{
    extend: 'Rally.ui.dialog.Dialog',
    alias: 'widget.tssettingsdialog',
    config: {
        title: 'Settings',
        model_type: 'HierarchicalRequirement',
        group_by_field_name: 'Schedulestate',
        metric: 'Count'
    },
    items: {
        xtype: 'panel',
        border: false,
        defaults: {
            padding: 5,
            margin: 5
        },
        items: [
            {
                xtype: 'container',
                itemId: 'model_selector_box'
            },
            {
                xtype:'container',
                itemId: 'group_field_selector_box'
            },
            {
                xtype:'container',
                itemId: 'metric_selector_box'
            }
        ]
    },
    constructor: function(config){
        this.mergeConfig(config);
        this.callParent([this.config]);
        
    },
    initComponent: function() {
        this.callParent(arguments);
        this.addEvents(
            /**
             * @event settingsChosen
             * Fires when user clicks done after making settings choices
             * @param {Rally.technicalservices.SettingsDialog} this
             * @param {hash} config settings
             */
            'settingsChosen',
            /**
             * @event cancelChosen
             * Fires when user clicks the cancel button
             */
            'cancelChosen'
        );
        this._buildButtons();
        this._addChoosers();
    },
    _buildButtons: function() {
        this.down('panel').addDocked({
            xtype: 'toolbar',
            dock: 'bottom',
            padding: '0 0 10 0',
            layout: {
                type: 'hbox',
                pack: 'center'
            },
            ui: 'footer',
            items: [
                {
                    xtype: 'rallybutton',
                    text: 'Run',
                    scope: this,
                    userAction: 'clicked done in dialog',
                    handler: function() {
                        this.fireEvent('settingsChosen', this, this._getConfig());
                        this.close();
                    }
                },
                {
                    xtype: 'rallybutton',
                    text: 'Cancel',
                    handler: function() {
                        this.fireEvent('cancelChosen');
                        this.close()
                    },
                    scope: this
                }
            ]
        });
    },
    _getConfig: function() {
        var config = {};
        if ( this.down('#model_chooser') ) {
            config.model_type = this.down('#model_chooser').getValue();
        }
        if ( this.down('#group_field_chooser') ) {
            config.group_by_field_name = this.down('#group_field_chooser').getValue();
            config.group_by_field_type = this.down('#group_field_chooser').getRecord().get('fieldDefinition').attributeDefinition.AttributeType;
        }
        if ( this.down('#metric_chooser') ) {
            config.metric = this.down('#metric_chooser').getValue();
        }
        return config;
    },
    _addChoosers: function() {
        var me = this;
        this._addModelChooser();
        this._addGroupChooser();
        this._addMetricChooser();
    },
    _addModelChooser: function() {
        var me = this;
        var type_store = Ext.create('Rally.data.custom.Store',{
            data: [
                {Name:'HierarchicalRequirement',Value:'HierarchicalRequirement'},
                {Name:'Defect',Value:'Defect'},
                {Name:'Task',Value:'Task'}
            ]
        });
        this.down('#model_selector_box').add({
            xtype:'rallycombobox',
            itemId: 'model_chooser',
            displayField: 'Name',
            valueField: 'Value',
            store: type_store,
            value: me.model_type,
            listeners: {
                scope: this,
                change: function(cb,new_value){
                    this.model_type = new_value;
                    this.group_by_field_name = null;
                    this.metric = "Count";
                    this._addGroupChooser();
                    this._addMetricChooser();
                }
            }
        });
    },
    _addGroupChooser: function() {
        var me = this;
        
        this.down('#group_field_selector_box').removeAll();
        var cb = this.down('#group_field_selector_box').add({
            xtype:'rallyfieldcombobox',
            itemId: 'group_field_chooser',
            model: me.model_type,
            value: me.group_by_field_name
        });
        var field_store = cb.getStore();
        field_store.on({
            'load': {
                fn: function(store,records) {
                    me._filterOutExceptChoices(store,records);
                    if ( me.group_by_field_name === null ) {
                        cb.setValue(store.getAt(0));
                    }
                },
             'scope': me
            }
        });

    },
    _addMetricChooser: function() {
        var me = this;
        
        this.down('#metric_selector_box').removeAll();
        var cb = this.down('#metric_selector_box').add({
            xtype:'rallyfieldcombobox',
            itemId: 'metric_chooser',
            model: me.model_type,
            value: me.metric
        });
        var field_store = cb.getStore();
        field_store.on('load',this._filterOutExceptNumbers,this,true);
        field_store.on({
            'load':{
                fn: function() { 
                    field_store.add({name:'Count',value:'Count',fieldDefinition:{}});
                    cb.setValue(me.metric);
                },
                single: true
            }
        });
    },
    _filterOutExceptChoices: function(store,records) {
        store.filter([{
            filterFn:function(field){ 
                var attribute_type = field.get('fieldDefinition').attributeDefinition.AttributeType;
                if (  attribute_type == "BOOLEAN" ) {
                    return true;
                }
                if ( attribute_type == "STRING" || attribute_type == "STATE" ) {
                    if ( field.get('fieldDefinition').attributeDefinition.Constrained ) {
                        return true;
                    }
                }
                return false;
            } 
        }]);
    },
    _filterOutExceptNumbers: function(store,records) {
        store.filter([{
            filterFn:function(field){ 
                var attribute_type = field.get('fieldDefinition').attributeDefinition.AttributeType;
                if (  attribute_type == "QUANTITY" || attribute_type == "INTEGER" || attribute_type == "DECIMAL" ) {
                    return true;
                }
                if ( field.get('name') == 'Count' ) { return true; }
                return false;
            } 
        }]);
    }
    
});
Ext.define('Rally.technicalservices.util.Utilities', {
    singleton: true,
    hashToArray: function(hash) {
        var result = [];
        for ( var key in hash ) {
            result.push(hash[key]);
        }
        return result;
    },

    daysBetween: function(begin_date_js,end_date_js,skip_weekends){
        var dDate1 = Ext.clone(begin_date_js).setHours(0,0,0,0);
        var dDate2 = Ext.clone(end_date_js).setHours(0,0,0,0);
        
        if ( dDate1 == dDate2 ) { return 0; }
        if (typeof dDate1 === "number") { dDate1 = new Date(dDate1); }
        if (typeof dDate2 === "number") { dDate2 = new Date(dDate2); }
            
        if ( !skip_weekends ) {
            return Math.abs( Rally.util.DateTime.getDifference(dDate1,dDate2,'day') );
        } else {
            // from the sOverflow
            var iWeeks, iDateDiff, iAdjust = 0;
            if (dDate2 < dDate1) 
            { 
                var x = dDate2;
                dDate2 = dDate1;
                dDate1 = x;
            }
            var iWeekday1 = dDate1.getDay(); // day of week
            var iWeekday2 = dDate2.getDay();
            iWeekday1 = (iWeekday1 == 0) ? 7 : iWeekday1; // change Sunday from 0 to 7
            iWeekday2 = (iWeekday2 == 0) ? 7 : iWeekday2;
            if ((iWeekday1 > 5) && (iWeekday2 > 5)) iAdjust = 1; // adjustment if both days on weekend
            iWeekday1 = (iWeekday1 > 5) ? 5 : iWeekday1; // only count weekdays
            iWeekday2 = (iWeekday2 > 5) ? 5 : iWeekday2;
    
            // calculate differnece in weeks (1000mS * 60sec * 60min * 24hrs * 7 days = 604800000)
            iWeeks = Math.floor((dDate2.getTime() - dDate1.getTime()) / 604800000)
    
            if (iWeekday1 <= iWeekday2) {
              iDateDiff = (iWeeks * 5) + (iWeekday2 - iWeekday1)
            } else {
              iDateDiff = ((iWeeks + 1) * 5) - (iWeekday1 - iWeekday2)
            }
    
            iDateDiff -= iAdjust // take into account both days on weekend
    
            if ( iDateDiff < 0 ) { iDateDiff = 0; }
            return (iDateDiff); 
        }
    },

    isWeekday: function(check_date) {
        var weekday = true;
        var day = check_date.getDay();
        
        if ( day === 0 || day === 6 ) {
            weekday = false;
        }
        return weekday;
    },
    
    arrayOfDaysBetween: function(begin_date_js, end_date_js, skip_weekends ) {
        var the_array = [];
        
        var dDate1 = Ext.clone(begin_date_js).setHours(0,0,0,0);
        var dDate2 = Ext.clone(end_date_js).setHours(0,0,0,0);
        
        var check_date = new Date(dDate1);
        
        while (check_date <= dDate2) {
            if ( !skip_weekends || this.isWeekday(check_date) ) {
                the_array.push(check_date);
            }
            check_date = Rally.util.DateTime.add(check_date,'day',1);
        }
        
        return the_array;
    }
    
    
});
Ext.define('CustomApp', {
    extend: 'Rally.app.App',
    componentCls: 'app',

    config: {
        model_type:'HierarchicalRequirement',
        start_date: Rally.util.DateTime.add(new Date(),"month",-1),
        end_date: new Date(),
        group_by_field_name: 'ScheduleState',
        metric: 'Count',
        groups:[]
    },
    logger: new Rally.technicalservices.Logger(),
    items: [
        {xtype:'container',itemId:'selector_box', margin: 5, padding: 5},
        {xtype:'container',itemId:'chart_box', margin: 5, padding: 5},
        {xtype:'tsinfolink',informationHtml:"<strong>Super-Customizable CFD</strong><p/>Start by pushing the Settings button"}
    ],
    launch: function() {
        this.logger.log("Launched with context", this.getContext(), "and config", this.config);
        this.down('#selector_box').add({
            xtype:'rallybutton',
            text:'Settings',
            handler: function() {
                this._showSettingsDialog();
            },
            scope: this
            
        });
    },
    _showSettingsDialog: function() {
        if ( this.dialog ) { this.dialog.destroy(); }
        var config = this.config;
        
        this.dialog = Ext.create('Rally.technicalservices.SettingsDialog',{
            model_type: config.model_type,
            width: 200,
            group_by_field_name: config.group_by_field_name,
            metric: config.metric,
            listeners: {
                settingsChosen: function(dialog,returned_config) {
                    this.config = Ext.Object.merge(this.config,returned_config);
                    this.logger.log("new config",this.config);
                    this._reCalculate();
                },
                scope: this
            }
        });
        this.dialog.show();
    },
    _reCalculate:function() {
        var me = this;
        this.down('#chart_box').removeAll();
        this.getEl().mask("Loading");

        var array_of_days = Rally.technicalservices.util.Utilities.arrayOfDaysBetween(this.config.start_date,this.config.end_date,true);
        
        var promises = _.map(array_of_days,me._getSnapshots,this);
        promises.push(me._getValidFieldChoices(),this);
        
        Deft.Promise.all(promises).then({
            success: function(days) {
                // got back an array of calculated data for each day (tsday model) (plus the null back from the other call)
                
                days.pop();
                days.pop();
                me._makeChart(days);
            }, 
            failure: function(records) {
                console.log("oops");
            }
        });
        
    },
    _getValidFieldChoices: function() {
        this.logger.log("_getValidFieldChoices");
        var deferred = Ext.create('Deft.Deferred');
        var config = this.config;
        var me = this;
        
        config.groups = [];
        
        if ( config.group_by_field_type === "BOOLEAN" ) {
            config.groups = ["true","false"];
            deferred.resolve("x");
        } else {
            Rally.data.ModelFactory.getModel({
                type: config.model_type,
                success: function(model){
                    var field = model.getField(config.group_by_field_name);
                    field.getAllowedValueStore().load({
                        callback: function(values,operation,success) {
                            Ext.Array.each(values, function(value){
                                config.groups.push(value.get('StringValue'));
                            });
                            deferred.resolve("x");
                        }
                    });
                    
                },
                scope: this
            });
        }
        
        return deferred.promise;
    },
    _getSnapshots:function(day){
        var config = this.config;
        
        var deferred = Ext.create('Deft.Deferred');
        
        this.logger.log("fetching snapshots at", day);
        var project = this.getContext().getProject().ObjectID;
        
        var date_array = 
        Ext.create('Rally.data.lookback.SnapshotStore',{
            fetch: [config.group_by_field_name, config.metric],
            autoLoad: true,
            filters: [
                {property:'_TypeHierarchy',value:config.model_type},
                {property:'__At',operator:'=',value:Rally.util.DateTime.toIsoString(day)},
                {property:'_ProjectHierarchy', value:project}
            ],
            hydrate: [config.group_by_field_name],
            listeners: {
                load: function(store,snaps,success){
                    if (success) {
                        this.logger.log("snaps",snaps);
                        var day_calculator = Ext.create('TSDay',{
                            metricFieldName: config.metric,
                            groupByFieldName:config.group_by_field_name,
                            JSDate: day
                        });
                        Ext.Array.each(snaps, function(snap){
                            day_calculator.addSnap(snap);
                        });
                        deferred.resolve(day_calculator);
                    } else {
                        deferred.reject("Error Loading Snapshots for " + day);
                    }
                },
                scope: this
            }
        });
        return deferred.promise;
    },
    _getCategories: function(days) {
        var me = this;
        this.logger.log("_getCategories");
        var categories = [];
        Ext.Array.each(days,function(day){
            categories.push(day.get('JSDate'));
        });
        return categories;
    },
    _getSeries: function(days){
        this.logger.log("_getSeries");
        var group_data = {};
        var series = [];
        
        var groups = this.config.groups;
        Ext.Array.each(groups, function(group){
            group_data[group] = [];
        });
        
        Ext.Array.each(days, function(day){
            if ( day ) {
                Ext.Array.each(groups,function(group_name){
                    var group_value = day.getGroupTotal(group_name);
                    group_data[group_name].push(group_value);
                });
            }
        });
        
        Ext.Array.each(groups,function(group_name){
            var display_group_name = group_name;
            if ( group_name == "" ) { display_group_name = "None"; }
            series.push({
                type:'area',
                name: display_group_name,
                data: group_data[group_name]
            });
        });
        
        return series;
    },
    _makeChart: function(days) {
        var me = this;
        this.logger.log("_makeChart",days);
        
        this.down('#chart_box').removeAll();
        
        var categories = this._getCategories(days);
        var series = this._getSeries(days);
        
        this.logger.log('categories',categories);
        this.logger.log('series',series);
        
        this.getEl().unmask();
        
        this.down('#chart_box').add({
            xtype:'rallychart',
            chartData: {
                series: series,
                categories: categories
            },
            chartConfig: {
                chart: { 
                    width: me.getWidth(),
                    type:'area'
                },
                title: {
                    text: '',
                    align: 'center'
                },
                xAxis: [
                    {
                        categories: categories,
                        labels: {
                            align: 'left',
                            rotation: 70,
                            formatter: function() {
                                return Ext.Date.format(this.value,'d-M');
                            }
                        }
                    }
                ],
                yAxis: [{title:{text:''}}],
                plotOptions: {
                    series: {
                        stacking: 'normal'
                    }
                }
            }
            
        });
        
    }
});

/**
 * the loading mask wasn't going away!
 */

Ext.override(Rally.ui.chart.Chart,{
    onRender: function () {
        this.callParent(arguments);
        this._unmask();
    }
});
            
               Rally.launchApp('CustomApp', {
                   name: 'Super Customizable Cumulative Flow Diagram'
               });
        });
    </script>
    
    <style type="text/css">

.app {
}
.tsinfolink {
    position:absolute;
    right:0px;
    width:5%;
}
    </style>

</head>
<body></body>
</html>